{% extends 'user/layout.html' %}
{% block title %}{% if is_edit %}Edit Loan{% else %}Add Loan{% endif %} | EMI Analyzer{% endblock %}
{% block content %}
<div class="mf-page-head">
    <div>
        <h4 class="mb-1">{% if is_edit %}Edit Loan{% else %}Loan Manager{% endif %}</h4>
        <p class="mb-0">{% if is_edit %}Update your existing loan details.{% else %}Add a new loan entry.{% endif %}</p>
    </div>
</div>
<div class="card mf-form-card"><div class="card-body p-4">
    <form method="post" id="loanForm">{% csrf_token %}
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Loan Type</label>
                <select class="form-select" name="loan_type" required>
                    <option value="">Select loan type</option>
                    <option value="Home Loan" {% if form_values.loan_type == 'Home Loan' %}selected{% endif %}>Home Loan</option>
                    <option value="Personal Loan" {% if form_values.loan_type == 'Personal Loan' %}selected{% endif %}>Personal Loan</option>
                    <option value="Car Loan" {% if form_values.loan_type == 'Car Loan' %}selected{% endif %}>Car Loan</option>
                    <option value="Bike Loan" {% if form_values.loan_type == 'Bike Loan' %}selected{% endif %}>Bike Loan</option>
                    <option value="Credit Card" {% if form_values.loan_type == 'Credit Card' %}selected{% endif %}>Credit Card</option>
                    <option value="BNPL" {% if form_values.loan_type == 'BNPL' %}selected{% endif %}>BNPL</option>
                    <option value="Education Loan" {% if form_values.loan_type == 'Education Loan' %}selected{% endif %}>Education Loan</option>
                    <option value="Gold Loan" {% if form_values.loan_type == 'Gold Loan' %}selected{% endif %}>Gold Loan</option>
                    <option value="Business Loan" {% if form_values.loan_type == 'Business Loan' %}selected{% endif %}>Business Loan</option>
                    <option value="Other" {% if form_values.loan_type == 'Other' %}selected{% endif %}>Other</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Lender / Bank</label>
                <input type="text" class="form-control" name="lender" maxlength="120" value="{{ form_values.lender }}" placeholder="e.g., HDFC Bank">
            </div>
            <div class="col-md-6">
                <label class="form-label">Total Principal (Outstanding if mid-loan)</label>
                <input type="number" class="form-control" id="principalInput" name="principal" min="1" value="{{ form_values.principal }}" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Interest Input Type</label>
                <select class="form-select" id="interestMode" name="interest_rate_mode">
                    <option value="annual" {% if form_values.interest_rate_mode != 'monthly' %}selected{% endif %}>Annual %</option>
                    <option value="monthly" {% if form_values.interest_rate_mode == 'monthly' %}selected{% endif %}>Monthly %</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Monthly EMI Amount</label>
                <input type="number" class="form-control" id="monthlyEmiInput" name="monthly_emi" min="1" value="{{ form_values.monthly_emi }}" placeholder="Leave blank to auto-calculate EMI">
                <small class="form-text text-muted" id="emiPercentHint">Enter interest or EMI details to view current interest percentage.</small>
            </div>
            <div class="col-md-6">
                <label class="form-label" id="interestRateLabel">Interest Rate (%)</label>
                <input type="number" class="form-control" id="interestRateInput" name="interest_rate" min="0" max="100" step="0.01" value="{{ form_values.interest_rate }}" placeholder="Leave blank to auto-calc from EMI">
                <small class="form-text text-muted" id="interestRateHelp">Enter annual interest %, or switch to monthly mode.</small>
            </div>
            <div class="col-md-6">
                <label class="form-label">Loan Period (Months)</label>
                <input type="number" class="form-control" id="loanPeriodMonths" name="loan_period_months" min="1" max="600" value="{{ form_values.loan_period_months }}" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">EMIs Already Paid (If Mid-Loan)</label>
                <input type="number" class="form-control" id="monthsPaid" name="months_paid" min="0" max="600" value="{{ form_values.months_paid }}">
                <small class="form-text text-muted" id="monthsPaidHint">Auto-calculated from start date and current date unless you edit manually.</small>
            </div>
            <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDateInput" name="start_date" min="{{ start_date_min }}" max="{{ start_date_max }}" value="{{ form_values.start_date }}" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" id="endDateInput" name="end_date" value="{{ form_values.end_date }}" readonly>
            </div>
            <div class="col-md-6">
                <label class="form-label">Current Interest (%)</label>
                <input type="text" class="form-control" id="emiPercentInput" value="" readonly>
            </div>
            <div class="col-12">
                <small class="text-muted" id="dateCalcHint">Start date allowed from {{ start_date_min }} to {{ start_date_max }}. End date is auto-filled.</small>
            </div>
            <div class="col-12 d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-primary btn-sm" id="calcEmiBtn"><i class="bi bi-calculator me-1"></i>Auto Calculate EMI</button>
                <small class="text-muted" id="emiCalcHint">Set principal, interest, period, and paid EMIs to auto-calculate.</small>
            </div>
        </div>
        <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary">{% if is_edit %}Update Loan{% else %}Save Loan{% endif %}</button>
            <a href="{% url 'loan_list' %}" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </form>
</div></div>
{% endblock %}
{% block extra_js %}
<script>
(function () {
    const principalInput = document.getElementById('principalInput');
    const interestMode = document.getElementById('interestMode');
    const interestRateInput = document.getElementById('interestRateInput');
    const interestRateLabel = document.getElementById('interestRateLabel');
    const interestRateHelp = document.getElementById('interestRateHelp');
    const monthlyEmiInput = document.getElementById('monthlyEmiInput');
    const loanPeriodMonths = document.getElementById('loanPeriodMonths');
    const monthsPaid = document.getElementById('monthsPaid');
    const monthsPaidHint = document.getElementById('monthsPaidHint');
    const startDateInput = document.getElementById('startDateInput');
    const endDateInput = document.getElementById('endDateInput');
    const dateCalcHint = document.getElementById('dateCalcHint');
    const calcEmiBtn = document.getElementById('calcEmiBtn');
    const emiCalcHint = document.getElementById('emiCalcHint');
    const emiPercentHint = document.getElementById('emiPercentHint');
    const emiPercentInput = document.getElementById('emiPercentInput');

    const incomeTotal = Number('{{ income_total|default:0 }}');
    const otherLoansEmi = Number('{{ other_loans_emi|default:0 }}');
    const greenLimit = Number('{{ green_limit|default:30 }}');
    const yellowLimit = Number('{{ yellow_limit|default:50 }}');
    const startDateMin = '{{ start_date_min|default:"" }}';
    const startDateMax = '{{ start_date_max|default:"" }}';
    let baseStartDateMin = startDateMin || '';
    let monthsPaidManual = false;
    let emiAutoCalculated = false;

    function parseIsoDate(value) {
        if (!value || !/^\d{4}-\d{2}-\d{2}$/.test(value)) {
            return null;
        }
        const parts = value.split('-').map((part) => Number(part));
        const d = new Date(parts[0], parts[1] - 1, parts[2]);
        if (
            Number.isNaN(d.getTime()) ||
            d.getFullYear() !== parts[0] ||
            d.getMonth() !== parts[1] - 1 ||
            d.getDate() !== parts[2]
        ) {
            return null;
        }
        return d;
    }

    function formatIsoDate(dateObj) {
        const y = dateObj.getFullYear();
        const m = String(dateObj.getMonth() + 1).padStart(2, '0');
        const d = String(dateObj.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function addMonthsClamped(baseDate, months) {
        const monthBase = new Date(baseDate.getFullYear(), baseDate.getMonth() + months, 1);
        const lastDay = new Date(monthBase.getFullYear(), monthBase.getMonth() + 1, 0).getDate();
        const targetDay = Math.min(baseDate.getDate(), lastDay);
        return new Date(monthBase.getFullYear(), monthBase.getMonth(), targetDay);
    }

    function todayLocalDate() {
        const today = new Date();
        return new Date(today.getFullYear(), today.getMonth(), today.getDate());
    }

    function startDateFromPaidMonths(paidMonths) {
        const current = todayLocalDate();
        return addMonthsClamped(current, -paidMonths);
    }

    function dynamicStartMinFromPaidMonths(paidMonths) {
        if (!Number.isFinite(paidMonths) || paidMonths < 0) {
            return baseStartDateMin;
        }
        const paidStartIso = formatIsoDate(startDateFromPaidMonths(paidMonths));
        if (!baseStartDateMin) {
            return paidStartIso;
        }
        return paidStartIso < baseStartDateMin ? paidStartIso : baseStartDateMin;
    }

    function applyDateBoundsAndDefaults() {
        const maxDate = todayLocalDate();
        if (!baseStartDateMin) {
            const minDate = addMonthsClamped(maxDate, -2);
            baseStartDateMin = formatIsoDate(minDate);
        }
        startDateInput.min = baseStartDateMin;
        startDateInput.max = startDateMax || formatIsoDate(maxDate);
        startDateInput.dataset.autoFromPaid = '0';
        if (!startDateInput.value && startDateInput.max) {
            startDateInput.value = startDateInput.max;
        }
    }

    function elapsedMonthsFromCurrentDate(start) {
        const current = todayLocalDate();
        if (current <= start) {
            return 0;
        }
        let months = (current.getFullYear() - start.getFullYear()) * 12 + (current.getMonth() - start.getMonth());
        if (current.getDate() < start.getDate()) {
            months -= 1;
        }
        return Math.max(0, months);
    }

    function updateMonthsPaidAuto() {
        if (monthsPaidManual) {
            const paidMonths = Number.parseInt(monthsPaid.value, 10);
            if (Number.isFinite(paidMonths) && paidMonths >= 0) {
                const suggestedStartIso = formatIsoDate(startDateFromPaidMonths(paidMonths));
                const dynamicStartMin = dynamicStartMinFromPaidMonths(paidMonths);
                if (dynamicStartMin) {
                    startDateInput.min = dynamicStartMin;
                }
                const shouldAutoSetStart = !startDateInput.value || startDateInput.dataset.autoFromPaid === '1';
                if (shouldAutoSetStart) {
                    startDateInput.value = suggestedStartIso;
                    startDateInput.dataset.autoFromPaid = '1';
                }
                monthsPaidHint.textContent = `Using manual value. Suggested start date: ${suggestedStartIso} for ${paidMonths} paid month(s).`;
            } else {
                startDateInput.min = baseStartDateMin;
                monthsPaidHint.textContent = 'Using manual value.';
            }
            monthsPaidHint.className = 'form-text text-info';
            return;
        }

        startDateInput.min = baseStartDateMin;
        startDateInput.dataset.autoFromPaid = '0';
        const start = parseIsoDate(startDateInput.value);
        const period = Number.parseInt(loanPeriodMonths.value, 10);
        if (!start) {
            monthsPaidHint.textContent = 'Set start date to auto-calculate paid EMIs.';
            monthsPaidHint.className = 'form-text text-muted';
            return;
        }

        let autoPaid = elapsedMonthsFromCurrentDate(start);
        if (Number.isFinite(period) && period > 0) {
            autoPaid = Math.min(autoPaid, Math.max(0, period - 1));
        }
        monthsPaid.value = String(autoPaid);
        monthsPaidHint.textContent = `Auto-set to ${autoPaid} based on current date.`;
        monthsPaidHint.className = 'form-text text-success';
    }

    function updateEmiPercentHint() {
        function emiForRate(principal, monthlyRate, tenureMonths) {
            if (principal <= 0 || tenureMonths <= 0) {
                return null;
            }
            if (monthlyRate <= 0) {
                return principal / tenureMonths;
            }
            const growth = Math.pow(1 + monthlyRate, tenureMonths);
            const denominator = growth - 1;
            if (denominator <= 0) {
                return null;
            }
            return (principal * monthlyRate * growth) / denominator;
        }

        function inferAnnualRatePercent(principal, emi, tenureMonths) {
            if (principal <= 0 || emi <= 0 || tenureMonths <= 0) {
                return null;
            }
            const minimumEmi = principal / tenureMonths;
            if (emi < minimumEmi) {
                return null;
            }
            if (Math.abs(emi - minimumEmi) < 1e-8) {
                return 0.0;
            }

            let low = 0.0;
            let high = 1.0;
            for (let i = 0; i < 120; i += 1) {
                const mid = (low + high) / 2;
                const candidate = emiForRate(principal, mid, tenureMonths);
                if (candidate === null) {
                    return null;
                }
                if (candidate > emi) {
                    high = mid;
                } else {
                    low = mid;
                }
            }
            return ((low + high) / 2) * 1200;
        }

        const principal = Number(principalInput.value);
        const emi = Number(monthlyEmiInput.value);
        const periodMonths = Number(loanPeriodMonths.value);
        const paidMonths = Number(monthsPaid.value || 0);
        const remainingMonths = periodMonths - paidMonths;
        const interestRateRaw = interestRateInput.value.trim();
        const interestRate = Number(interestRateRaw);

        if (interestRateRaw && !Number.isNaN(interestRate) && interestRate >= 0) {
            const annualRate = interestMode.value === 'monthly' ? (interestRate * 12) : interestRate;
            const monthlyRate = interestMode.value === 'monthly' ? interestRate : (interestRate / 12);
            emiPercentInput.value = `${annualRate.toFixed(2)}% annual`;
            emiPercentHint.textContent = `Current interest: ${annualRate.toFixed(2)}% yearly (${monthlyRate.toFixed(2)}% monthly).`;
            emiPercentHint.className = 'form-text text-info';
            return;
        }

        if (
            principal > 0
            && emi > 0
            && Number.isFinite(periodMonths)
            && periodMonths > 0
            && Number.isFinite(paidMonths)
            && paidMonths >= 0
            && paidMonths < periodMonths
            && remainingMonths > 0
        ) {
            const inferredAnnualRate = inferAnnualRatePercent(principal, emi, remainingMonths);
            if (inferredAnnualRate !== null && inferredAnnualRate <= 100) {
                const inferredMonthlyRate = inferredAnnualRate / 12;
                emiPercentInput.value = `${inferredAnnualRate.toFixed(2)}% annual`;
                emiPercentHint.textContent = `Inferred interest: ${inferredAnnualRate.toFixed(2)}% yearly (${inferredMonthlyRate.toFixed(2)}% monthly).`;
                emiPercentHint.className = 'form-text text-success';
                return;
            }
            if (inferredAnnualRate !== null && inferredAnnualRate > 100) {
                emiPercentInput.value = '';
                emiPercentHint.textContent = 'Inferred interest is above 100%. Please verify principal, EMI, and period.';
                emiPercentHint.className = 'form-text text-warning';
                return;
            }
        }

        emiPercentInput.value = '';
        emiPercentHint.textContent = 'Enter annual/monthly interest, or principal + EMI + tenure to view current interest percentage.';
        emiPercentHint.className = 'form-text text-muted';
    }

    function syncDateFields() {
        const start = parseIsoDate(startDateInput.value);
        const period = Number.parseInt(loanPeriodMonths.value, 10);
        const effectiveStartMin = startDateInput.min || baseStartDateMin;

        if (start) {
            const startIso = formatIsoDate(start);
            if (effectiveStartMin && startIso < effectiveStartMin) {
                dateCalcHint.textContent = `Start date cannot be before ${effectiveStartMin}.`;
                dateCalcHint.className = 'text-warning';
                endDateInput.value = '';
                updateMonthsPaidAuto();
                return;
            }
            if (startDateMax && startIso > startDateMax) {
                dateCalcHint.textContent = `Start date cannot be after ${startDateMax}.`;
                dateCalcHint.className = 'text-warning';
                endDateInput.value = '';
                updateMonthsPaidAuto();
                return;
            }
        }

        if (Number.isFinite(period) && period > 0) {
            if (start) {
                const derivedEnd = addMonthsClamped(start, period - 1);
                endDateInput.value = formatIsoDate(derivedEnd);
                dateCalcHint.textContent = `End date auto-set from start date + ${period} month(s).`;
                dateCalcHint.className = 'text-success';
                updateMonthsPaidAuto();
                return;
            }
        }

        endDateInput.value = '';
        dateCalcHint.textContent = `Start date allowed from ${effectiveStartMin || 'N/A'} to ${startDateMax || 'N/A'}. End date is auto-filled.`;
        dateCalcHint.className = 'text-muted';
        updateMonthsPaidAuto();
    }

    function updateRateCopy() {
        if (interestMode.value === 'monthly') {
            interestRateLabel.textContent = 'Monthly Interest Rate (%)';
            interestRateHelp.textContent = 'Monthly input is converted to annual rate automatically.';
            interestRateInput.max = '8.33';
        } else {
            interestRateLabel.textContent = 'Annual Interest Rate (%)';
            interestRateHelp.textContent = 'Enter annual interest %, or switch to monthly mode.';
            interestRateInput.max = '100';
        }
    }

    function canRecalculateAutoEmi() {
        const principal = Number(principalInput.value);
        const periodMonths = Number(loanPeriodMonths.value);
        const paidMonths = Number(monthsPaid.value || 0);
        const interestRateRaw = interestRateInput.value.trim();
        const interestRate = Number(interestRateRaw);
        if (!principal || principal <= 0) {
            return false;
        }
        if (!periodMonths || periodMonths <= 0) {
            return false;
        }
        if (!Number.isFinite(paidMonths) || paidMonths < 0 || paidMonths >= periodMonths) {
            return false;
        }
        if (!interestRateRaw || Number.isNaN(interestRate) || interestRate < 0) {
            return false;
        }
        return true;
    }

    function refreshProjectedPercent() {
        const hasEmiValue = monthlyEmiInput.value.trim() !== '';
        const shouldAutoFillEmi = !hasEmiValue || emiAutoCalculated;
        if (shouldAutoFillEmi && canRecalculateAutoEmi()) {
            calculateEmi();
            return;
        }
        updateEmiPercentHint();
    }

    function calculateEmi() {
        syncDateFields();
        const principal = Number(principalInput.value);
        const interestRate = Number(interestRateInput.value);
        const periodMonths = Number(loanPeriodMonths.value);
        const paidMonths = Number(monthsPaid.value || 0);

        if (!principal || principal <= 0) {
            emiCalcHint.textContent = 'Enter a valid principal amount first.';
            emiCalcHint.className = 'text-warning';
            return;
        }
        if (!periodMonths || periodMonths <= 0) {
            emiCalcHint.textContent = 'Enter total loan period in months.';
            emiCalcHint.className = 'text-warning';
            return;
        }
        if (paidMonths < 0 || paidMonths >= periodMonths) {
            emiCalcHint.textContent = 'EMIs already paid must be between 0 and period-1.';
            emiCalcHint.className = 'text-warning';
            return;
        }
        if (Number.isNaN(interestRate) || interestRate < 0) {
            emiCalcHint.textContent = 'Enter a valid interest rate to auto-calculate EMI.';
            emiCalcHint.className = 'text-warning';
            return;
        }

        const remainingMonths = periodMonths - paidMonths;
        const monthlyRate = interestMode.value === 'monthly' ? (interestRate / 100) : (interestRate / 1200);

        let emiValue;
        if (monthlyRate === 0) {
            emiValue = principal / remainingMonths;
        } else {
            const growth = Math.pow(1 + monthlyRate, remainingMonths);
            emiValue = (principal * monthlyRate * growth) / (growth - 1);
        }

        const roundedEmi = Math.max(1, Math.round(emiValue));
        monthlyEmiInput.value = String(roundedEmi);
        emiAutoCalculated = true;
        emiCalcHint.textContent = `Auto-calculated EMI: Rs. ${roundedEmi.toLocaleString()} for ${remainingMonths} remaining month(s).`;
        emiCalcHint.className = 'text-success';
        updateEmiPercentHint();
    }

    updateRateCopy();
    applyDateBoundsAndDefaults();
    syncDateFields();
    updateEmiPercentHint();
    calcEmiBtn.addEventListener('click', calculateEmi);
    interestMode.addEventListener('change', function () {
        updateRateCopy();
        refreshProjectedPercent();
    });
    interestRateInput.addEventListener('input', refreshProjectedPercent);
    principalInput.addEventListener('input', refreshProjectedPercent);
    loanPeriodMonths.addEventListener('input', function () {
        syncDateFields();
        refreshProjectedPercent();
    });
    startDateInput.addEventListener('change', function () {
        startDateInput.dataset.autoFromPaid = '0';
        syncDateFields();
        refreshProjectedPercent();
    });
    monthlyEmiInput.addEventListener('input', function () {
        emiAutoCalculated = false;
        refreshProjectedPercent();
    });
    monthsPaid.addEventListener('input', function () {
        const hasValue = monthsPaid.value.trim() !== '';
        monthsPaidManual = hasValue;
        if (!hasValue) {
            monthsPaidManual = false;
            startDateInput.dataset.autoFromPaid = '0';
            updateMonthsPaidAuto();
            syncDateFields();
        } else {
            startDateInput.dataset.autoFromPaid = '1';
            updateMonthsPaidAuto();
            syncDateFields();
        }
        refreshProjectedPercent();
    });
})();
</script>
{% endblock %}
